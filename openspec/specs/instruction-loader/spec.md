# instruction-loader 规范

## 目的
instruction-loader 从 schema 目录加载指令模板，使用元数据和参数（例如变更上下文和依赖项状态）对其进行验证和丰富，并将其公开以供下游服务使用，包括模板检索、参数替换和丰富。

## 需求
### 需求：模板加载
系统必须从 schema 目录加载模板。

#### 场景：从 schema 目录加载模板
- **当** 调用 `loadTemplate(schemaName, templatePath)` 时
- **那么** 系统从 `schemas/<schemaName>/templates/<templatePath>` 加载模板

#### 场景：未找到模板文件
- **当** 模板文件不存在于 schema 的模板目录中时
- **那么** 系统抛出包含模板路径的错误

### 需求：变更上下文加载
系统必须加载结合了图形和完成状态的变更上下文。

#### 场景：为现有变更加载上下文
- **当** 为现有变更调用 `loadChangeContext(projectRoot, changeName)` 时
- **那么** 系统返回包含图形、已完成集合、schema 名称和变更信息的上下文

#### 场景：使用自定义 schema 加载上下文
- **当** 调用 `loadChangeContext(projectRoot, changeName, schemaName)` 时
- **那么** 系统使用指定的 schema 而不是默认值

#### 场景：为不存在的变更目录加载上下文
- **当** 为不存在的变更目录调用 `loadChangeContext` 时
- **那么** 系统返回带有空已完成集合的上下文

### 需求：模板丰富
系统必须使用特定于变更的上下文丰富模板。

#### 场景：包含产物元数据
- **当** 为产物生成指令时
- **那么** 输出包含变更名称、产物 ID、schema 名称和输出路径

#### 场景：包含依赖项状态
- **当** 产物具有依赖项时
- **那么** 输出显示每个依赖项的完成状态（已完成/缺失）

#### 场景：包含已解锁产物
- **当** 生成指令时
- **那么** 输出包含在此之后变得可用的产物

#### 场景：根产物指示器
- **当** 产物没有依赖项时
- **那么** 依赖项部分指示这是一个根产物

### 需求：状态格式化
系统必须将变更状态格式化为可读输出。

#### 场景：所有产物已完成
- **当** 所有产物都已完成时
- **那么** 状态将所有产物显示为 "done"

#### 场景：混合完成状态
- **当** 一些产物已完成时
- **那么** 状态将已完成的显示为 "done"，准备好的显示为 "ready"，受阻的显示为 "blocked"

#### 场景：受阻产物详情
- **当** 产物受阻时
- **那么** 状态显示缺少哪些依赖项

#### 场景：包含输出路径
- **当** 格式化状态时
- **那么** 每个产物显示其输出路径模式
