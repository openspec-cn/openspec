# CI Nix 验证规范 (ci-nix-validation Specification)

## 目的

在 CI 中验证 Nix flake 构建和维护脚本，以确保 Nix 用户可以可靠地安装和使用 OpenSpec。通过在每次拉取请求 (PR) 和推送到 main 分支时测试构建和 update-flake.sh 脚本，防止 Nix 支持退化。

## 需求

### 需求：Nix Flake 构建验证

CI 系统必须在每次拉取请求和推送到 main 分支时验证 Nix flake 构建成功。

#### 场景：成功的 flake 构建

- **当** 进行拉取请求或推送到 main 分支时
- **那么** CI 必须执行 `nix build` 并验证其以退出代码 0 完成
- **且** 构建输出必须包含 openspec 二进制文件

#### 场景：Flake 构建失败

- **当** Nix flake 配置损坏时
- **那么** CI 作业必须以非零退出代码失败
- **且** CI 必须阻止合并拉取请求

#### 场景：多平台支持检查

- **当** flake 声明支持多个系统时
- **那么** CI 必须验证 flake 至少在 Linux (x86_64-linux) 上构建成功

### 需求：更新脚本验证

CI 系统必须验证 update-flake.sh 脚本执行成功并产生有效的输出。

#### 场景：更新脚本执行

- **当** CI 运行更新脚本验证时
- **那么** 脚本必须无错误执行
- **且** 脚本必须正确地从 package.json 读取版本
- **且** 脚本必须验证 flake.nix 使用来自 package.json 的动态版本

#### 场景：带模拟哈希的更新脚本

- **当** 在 CI 中验证更新脚本时
- **那么** 脚本必须能够检测并提取正确的 pnpm 依赖哈希
- **且** flake.nix 必须用有效的 sha256 哈希更新

### 需求：CI 作业集成

Nix 验证作业必须集成到现有的 GitHub Actions 工作流中，并且合并时必须要求通过。

#### 场景：PR 合并要求

- **当** 创建拉取请求时
- **那么** Nix 验证作业必须包含在必需的检查中
- **且** PR 在 Nix 验证通过之前不得合并

#### 场景：作业执行触发器

- **当** 代码推送到拉取请求 或 推送到 main 分支 或 手动触发时
- **那么** Nix 验证作业必须自动执行

### 需求：本地测试支持

CI 工作流必须可以使用 `act` 工具在本地进行测试，以实现快速迭代。

#### 场景：使用 act 本地执行 CI

- **当** 开发人员使用 Nix 验证工作流运行 `act` 时
- **那么** 工作流必须在本地 Docker 环境中执行
- **且** 开发人员必须在不推送到 GitHub 的情况下收到关于 Nix 构建状态的反馈

#### 场景：Act 配置兼容性

- **当** 设计工作流时
- **那么** 它必须使用与 `act` 兼容的标准 GitHub Actions 语法
- **且** 任何特定于 Nix 的设置必须在 act Docker 环境中工作

### 需求：CI 中的 Nix 安装

CI 环境必须在运行验证之前正确安装和配置 Nix。

#### 场景：Nix 安装步骤

- **当** Nix 验证作业开始时
- **那么** Nix 必须使用官方 Nix 安装程序或 determinatesystems/nix-installer-action 安装
- **且** Nix 安装必须被缓存以供后续运行使用，以提高性能

#### 场景：CI 的 Nix 配置

- **当** 在 CI 中安装 Nix 时
- **那么** 它必须被配置为在 GitHub Actions 环境中工作
- **且** 必须启用实验性功能 (flakes, nix-command)

### 需求：CI 性能优化

Nix 验证必须经过优化，以尽量减少 CI 运行时的影响。

#### 场景：可接受的运行时间

- **当** Nix 验证作业运行时
- **那么** 它必须在干净运行时 5 分钟内完成
- **且** 使用缓存时，它必须在后续运行中 3 分钟内完成

#### 场景：并行执行

- **当** 多个 CI 作业正在运行时
- **那么** Nix 验证作业必须与其他验证作业（测试、lint）并行运行
- **且** 不得阻塞其他独立检查
