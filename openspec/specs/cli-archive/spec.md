# CLI 归档命令规范 (CLI Archive Command Specification)

## 目的
归档命令按照 OpenSpec 约定，将已完成的变更从活跃变更目录移动到带有基于日期命名的归档文件夹中。

## 命令语法
```bash
openspec archive [change-name] [--yes|-y]
```

选项：
- `--yes`, `-y`: 跳过确认提示（用于自动化）

## 需求

### 需求：变更选择

该命令必须支持交互式和直接变更选择方法。

#### 场景：交互式选择

- **当** 未提供 change-name 时
- **那么** 显示可用变更的交互式列表（不包括 archive/）
- **且** 允许用户选择一个

#### 场景：直接选择

- **当** 提供了 change-name 时
- **那么** 直接使用该变更
- **且** 验证其存在

### 需求：任务完成检查

该命令必须在归档前验证任务完成状态，以防止过早归档。

#### 场景：发现未完成任务

- **当** 发现未完成任务（标记为 `- [ ]`）时
- **那么** 向用户显示所有未完成任务
- **且** 提示确认是否继续
- **且** 默认为“否”以确保安全

#### 场景：所有任务完成

- **当** 所有任务已完成 或 不存在 tasks.md 时
- **那么** 无需提示直接进行归档

### 需求：归档过程

归档操作必须遵循结构化过程，以安全地将变更移动到归档中。

#### 场景：执行归档

- **当** 归档变更时
- **那么** 执行以下步骤：
  1. 如果 archive/ 目录不存在则创建
  2. 使用当前日期生成目标名称 `YYYY-MM-DD-[change-name]`
  3. 检查目标目录是否已存在
  4. 从变更的未来状态规范更新主规范（参见下面的规范更新过程）
  5. 将整个变更目录移动到归档位置

#### 场景：归档已存在

- **当** 目标归档已存在时
- **那么** 以错误消息失败
- **且** 不要覆盖现有归档

#### 场景：归档成功

- **当** 移动成功时
- **那么** 显示包含归档名称和已更新规范列表的成功消息

### 需求：规范更新过程

在将变更移动到归档之前，该命令必须将增量更改应用到主规范，以反映已部署的现实。

#### 场景：应用增量更改

- **当** 归档带有基于增量规范的变更时
- **那么** 按照 openspec-conventions 定义解析并应用增量更改
- **且** 在应用之前验证所有操作

#### 场景：验证增量更改

- **当** 处理增量更改时
- **那么** 执行 openspec-conventions 中指定的验证
- **且** 如果验证失败，显示具体错误并中止

#### 场景：冲突检测

- **当** 应用增量会导致重复的需求标题时
- **那么** 用显示冲突的错误消息中止
- **且** 建议手动解决

### 需求：确认行为

规范更新确认必须在应用更改之前提供清晰的可见性。

#### 场景：显示确认

- **当** 提示确认时
- **那么** 显示清晰的摘要，包括：
  - 将创建哪些规范（新能力）
  - 将更新哪些规范（现有能力）
  - 每个规范的源路径
- **且** 将确认提示格式化为：
  ```
  The following specs will be updated:
  
  NEW specs to be created:
    - cli-archive (from changes/add-archive-command/specs/cli-archive/spec.md)
  
  EXISTING specs to be updated:
    - cli-init (from changes/update-init-command/specs/cli-init/spec.md)
  
  Update 2 specs and archive 'add-archive-command'? [y/N]:
  ```

#### 场景：处理确认响应

- **当** 等待用户确认时
- **那么** 默认为“否”以确保安全（需要明确输入 "y" 或 "yes"）
- **且** 当提供 `--yes` 或 `-y` 标志时跳过确认

#### 场景：用户拒绝确认

- **当** 用户拒绝确认时
- **那么** 中止整个归档操作
- **且** 显示消息："Archive cancelled. No changes were made."
- **且** 以非零状态码退出

### 需求：错误条件

该命令必须优雅地处理各种错误条件。

#### 场景：处理错误

- **当** 发生错误时
- **那么** 处理以下情况：
  - 缺失 openspec/changes/ 目录
  - 未找到变更
  - 归档目标已存在
  - 文件系统权限问题

### 需求：跳过规范选项

归档命令必须支持 `--skip-specs` 标志，该标志跳过所有规范更新操作并直接进行归档。

#### 场景：使用标志跳过规范更新

- **当** 执行 `openspec archive <change> --skip-specs` 时
- **那么** 跳过规范发现和更新确认
- **且** 直接进行将变更移动到归档
- **且** 显示一条消息表明规范已被跳过

### 需求：非阻塞确认

当用户拒绝规范更新时，归档操作必须继续，而不是取消整个操作。

#### 场景：用户拒绝规范更新确认

- **当** 用户拒绝规范更新确认时
- **那么** 跳过规范更新
- **且** 继续归档操作
- **且** 显示成功消息表明规范未更新

### 需求：显示输出

该命令必须提供关于增量操作的清晰反馈。

#### 场景：显示增量应用

- **当** 应用增量更改时
- **那么** 为每个规范显示：
  - 添加的需求数量
  - 修改的需求数量
  - 移除的需求数量
  - 重命名的需求数量
- **且** 使用 openspec-conventions 中定义的标准输出符号 (+ ~ - →)：
  ```
  Applying changes to specs/user-auth/spec.md:
    + 2 added
    ~ 3 modified
    - 1 removed
    → 1 renamed
  ```

### 需求：归档验证

归档命令必须在应用变更之前验证它们，以确保数据完整性。

#### 场景：归档前验证

- **当** 执行 `openspec archive change-name` 时
- **那么** 首先验证变更结构
- **且** 仅当验证通过时才继续
- **且** 如果失败则显示验证错误

#### 场景：强制归档不验证

- **当** 执行 `openspec archive change-name --no-validate` 时
- **那么** 跳过验证（不安全模式）
- **且** 显示关于跳过验证的警告

## 为什么做出这些决定

**交互式选择**：减少打字并帮助用户查看可用变更
**任务检查**：防止意外归档未完成的工作
**日期前缀**：保持时间顺序并防止命名冲突
**不覆盖**：保留历史归档并防止数据丢失
**归档前更新规范**：主目录中的规范代表当前的现实；当变更部署并归档时，其未来状态规范成为新的现实，必须替换主规范
**规范更新确认**：提供即将发生更改的可见性，防止意外覆盖，并确保用户在修改规范之前了解影响
**用于自动化的 --yes 标志**：允许 CI/CD 管道在没有交互式提示的情况下进行归档，同时保持手动使用的默认安全性
