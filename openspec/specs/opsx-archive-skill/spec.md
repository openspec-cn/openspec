# OPSX Archive 技能规范

### 需求：OPSX Archive 技能

系统必须提供 `/opsx:archive` 技能，用于在实验性工作流中归档已完成的变更。

#### 场景：归档所有产物都已完成的变更

- **当** 代理使用变更名称执行 `/opsx:archive` 时
- **并且** schema 中的所有产物都已完成
- **并且** 所有任务都已完成
- **那么** 代理将变更移动到 `openspec/changes/archive/YYYY-MM-DD-<name>/`
- **并且** 显示包含归档位置的成功消息

#### 场景：变更选择提示

- **当** 代理执行 `/opsx:archive` 但未指定变更时
- **那么** 代理提示用户从可用变更中选择
- **并且** 仅显示活动变更（排除 archive/）

### 需求：产物完成检查

技能必须在归档之前使用产物图检查产物完成状态。

#### 场景：不完整产物警告

- **当** 代理检查产物状态时
- **并且** 一个或多个产物的状态不是 `done`
- **那么** 显示列出不完整产物的警告
- **并且** 提示用户确认是否继续
- **并且** 如果用户确认则继续

#### 场景：所有产物已完成

- **当** 代理检查产物状态时
- **并且** 所有产物的状态都是 `done`
- **那么** 无警告继续

### 需求：任务完成检查

技能必须在归档之前从 tasks.md 检查任务完成状态。

#### 场景：发现未完成的任务

- **当** 代理读取 tasks.md 时
- **并且** 发现未完成的任务（标记为 `- [ ]`）
- **那么** 显示显示未完成任务计数的警告
- **并且** 提示用户确认是否继续
- **并且** 如果用户确认则继续

#### 场景：所有任务已完成

- **当** 代理读取 tasks.md 时
- **并且** 所有任务都已完成（标记为 `- [x]`）
- **那么** 无任务相关警告继续

#### 场景：无任务文件

- **当** tasks.md 不存在时
- **那么** 无任务相关警告继续

### 需求：Spec Sync 提示

如果有规范存在，技能必须在归档之前提示同步增量规范。

#### 场景：增量规范存在

- **当** 代理检查增量规范时
- **并且** 变更中存在 `specs/` 目录且包含规范文件
- **那么** 提示用户："This change has delta specs. Would you like to sync them to main specs before archiving?"（此变更具有增量规范。您想在归档之前将它们同步到主规范吗？）
- **并且** 如果用户确认，执行 `/opsx:sync` 逻辑
- **并且** 无论同步选择如何，都继续归档

#### 场景：无增量规范

- **当** 代理检查增量规范时
- **并且** 不存在 `specs/` 目录或规范文件
- **那么** 不进行同步提示继续

### 需求：归档流程

技能必须将变更移动到带有日期前缀的归档文件夹。

#### 场景：成功归档

- **当** 归档变更时
- **那么** 如果 `archive/` 目录不存在则创建它
- **并且** 使用当前日期生成目标名称为 `YYYY-MM-DD-<change-name>`
- **并且** 将整个变更目录移动到归档位置
- **并且** 在已归档的变更中保留 `.openspec.yaml` 文件

#### 场景：归档已存在

- **当** 目标归档目录已存在时
- **那么** 失败并显示错误消息
- **并且** 建议重命名现有归档或使用不同日期

### 需求：技能输出

技能必须提供关于归档操作的清晰反馈。

#### 场景：带同步的归档完成

- **当** 同步规范后归档完成时
- **那么** 显示摘要：
  - 已同步规范（来自 `/opsx:sync` 输出）
  - 变更已归档到位置
  - 使用的 Schema

#### 场景：无同步的归档完成

- **当** 未同步规范归档完成时
- **那么** 显示摘要：
  - 注意规范未同步（如果适用）
  - 变更已归档到位置
  - 使用的 Schema

#### 场景：带警告的归档完成

- **当** 归档完成但有不完整的产物或任务时
- **那么** 包含关于什么不完整的注释
- **并且** 建议审查归档是否有意为之
